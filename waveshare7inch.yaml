# ==============================================================================
#  WAVESHARE ESP32-S3-TOUCH-LCD-7 (800x480) - FIXED SCALES & CLOCK
#  DATE: February 24, 2026
# ==============================================================================
#  UI UPDATES:
#  - Scales: Standardized temperature (0-120), humidity (0-100), and barometer (28-31)
#    to use 1:1 human-readable increments.
#  - Clock: Added 60 minor ticks and 12 major ticks for standard watch face.
# ==============================================================================

esphome:
  name: waveshare7inch
  friendly_name: waveshare7inch

  platformio_options:
    build_flags: "-DBOARD_HAS_PSRAM"
    board_build.esp-idf.memory_type: qio_opi
    board_build.flash_mode: dio
    board_upload.maximum_ram_size: 524288
    board_build.flash_size: 8MB 

# ---------------------------------------------------------
# HARDWARE FOUNDATION 
# ---------------------------------------------------------
packages:
  remote_package:
    url: https://github.com/inytar/waveshare-esp32-s3-touch-lcd-7-esphome
    ref: main
    file: waveshare-esp32-s3-touch-lcd-7.yaml
    refresh: 1h 

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: esp-idf 

logger:
  level: DEBUG
  hardware_uart: UART0
  baud_rate: 115200 

api:
  encryption:
    key: "Dgnfz00FQ13sV8dbeFs2Qq8GKbnaKLQLYAJyYlgqDGw=" 

ota:
  - platform: esphome
    password: "47cd6b83e7204067ea2e46f0fced55da" 

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  power_save_mode: NONE 
  on_connect:
    - component.update: my_online_image
  ap:
    ssid: "Waveshare7Inch Fallback"
    password: "C39c7PHHW3m1" 

web_server:
  port: 80
  include_internal: True
  version: 3 

captive_portal:

time:
  - platform: homeassistant
    id: homeassistant_time
    timezone: America/Chicago
    on_time:
      - seconds: "*"
        then:
          - script.execute: time_update 

# ---------------------------------------------------------
# UI & GRAPHICS
# ---------------------------------------------------------
http_request:
  verify_ssl: False 

online_image:
  - url: "http://homeassistant.local:8123/local/Paris800_480.png"
    format: png
    id: my_online_image
    type: RGB565
    resize: 800x480
    on_download_finished:
      lvgl.image.update: {id: first_image, src: my_online_image} 

image:
  - file: bulb.png
    id: bulb_image
    resize: 750x420
    type: RGB565 

font:
  - file: "gfonts://Montserrat"
    id: montserrat_20
    size: 20 
  - file: "gfonts://Montserrat"
    id: unscii_16
    size: 16 
  - file: "gfonts://Material Symbols Outlined"
    id: icon_font
    size: 32
    glyphs: "\uE0F0\uE5C4\uE88A\uE8AC\uE5C8" 

# ---------------------------------------------------------
# LVGL CONFIGURATION 
# ---------------------------------------------------------
lvgl:
  buffer_size: 10% 
  style_definitions:
    - id: header_footer
      text_font: icon_font
      bg_color: 0x2F8CD8
      bg_grad_color: 0x005782
      bg_grad_dir: VER
      bg_opa: COVER
      border_width: 0
      radius: 0
      pad_all: 0
      text_color: 0xFFFFFF
      width: 100%
      height: 40 
    - id: date_style
      text_font: unscii_16
      align: center
      text_color: 0x000000 

  pages:
    - id: main_page      
      widgets:
          - image: {src: bulb_image, align: CENTER, id: first_image} 

    - id: meter_page_1
      widgets:
        - meter:
            align: LEFT_MID
            height: 350
            width: 350
            scales:
              - range_from: 0
                range_to: 120
                angle_range: 240
                rotation: 150
                ticks:
                  width: 2
                  count: 61      
                  length: 10
                  color: 0x000000
                  major: {stride: 5, width: 3, length: 15, color: 0xFF0000}
                indicators:
                  - line: {id: temperature_needle, width: 2, color: 0xFF0000}
            widgets:
              - label: {id: temperature_text, text: "-.- F", align: CENTER, y: 45}
              - label: {text: "Inside Temp", align: CENTER, y: 65} 
        - meter:
            align: RIGHT_MID
            height: 350
            width: 350
            scales:
              - range_from: 0
                range_to: 100
                angle_range: 240
                rotation: 150
                ticks:
                  width: 2
                  count: 21      
                  length: 10
                  color: 0x000000
                  major: {stride: 2, width: 3, length: 15, color: 0xFF0000}
                indicators:
                  - line: {id: humidity_needle, width: 2, color: 0xFF0000}
            widgets:
              - label: {id: humidity_text, text: "-.- %", align: CENTER, y: 45}
              - label: {text: "Inside Humidity", align: CENTER, y: 65} 

    - id: meter_page_2
      widgets:
        - meter:
            align: LEFT_MID
            height: 350
            width: 350
            scales:
              - range_from: 0
                range_to: 120
                angle_range: 240
                rotation: 150
                ticks:
                  width: 2
                  count: 61
                  length: 10
                  color: 0x000000
                  major: {stride: 5, width: 3, length: 15, color: 0xFF0000}
                indicators:
                  - line: {id: temperature_needle_2, width: 2, color: 0xFF0000}
            widgets:
              - label: {id: temperature_text_2, text: "-.- F", align: CENTER, y: 45}
              - label: {text: "Outside Temp", align: CENTER, y: 65} 
        - meter:
            align: RIGHT_MID
            height: 350
            width: 350
            scales:
              - range_from: 0
                range_to: 100
                angle_range: 240
                rotation: 150
                ticks:
                  width: 2
                  count: 21
                  length: 10
                  color: 0x000000
                  major: {stride: 2, width: 3, length: 15, color: 0xFF0000}
                indicators:
                  - line: {id: humidity_needle_2, width: 2, color: 0xFF0000}
            widgets:
              - label: {id: humidity_text_2, text: "-.- %", align: CENTER, y: 45}
              - label: {text: "Outside Humidity", align: CENTER, y: 65} 

    - id: meter_page_3
      bg_color: Black
      widgets:
        - meter:
            align: CENTER
            height: 400
            width: 400
            scales:
              - range_from: 28
                range_to: 31
                angle_range: 240
                rotation: 150
                ticks:
                  width: 2
                  count: 31      
                  length: 10
                  color: 0x0000FF
                  major: {stride: 10, width: 3, length: 15, color: 0xFFFFFF}
                indicators:
                  - line: {id: barometer_needle, width: 4, color: 0xFF0000}
        - label: {id: barometer_text, styles: date_style, text: "inHg", align: CENTER, y: 85}
        - label: {styles: date_style, text: "Barometer", align: CENTER, y: 65} 

    - id: clock_page
      bg_color: Black
      widgets:
        - meter:
            id: analog_clock
            height: 400
            width: 400
            align: CENTER
            bg_color: White
            border_width: 0
            outline_width: 0
            scales:
              - range_from: 0
                range_to: 60
                angle_range: 360
                rotation: 270
                ticks:
                  width: 2
                  count: 60
                  length: 10
                  color: 0x555555
                  major: {stride: 5, width: 4, length: 15, color: 0x000000}
                indicators:
                  - line: {id: minute_hand, width: 4, color: 0x000000, r_mod: -15}
                  - line: {id: second_hand, width: 2, color: 0xFF0000, r_mod: -5}
              - range_from: 0
                range_to: 720
                angle_range: 360
                rotation: 270
                indicators:
                  - line: {id: hour_hand, width: 6, color: 0x000000, r_mod: -45}
            widgets:
              - label: {id: day_label, styles: date_style, align: CENTER, y: -60}
              - label: {id: date_label, styles: date_style, align: CENTER, y: 60} 

    - id: test1_page
      bg_color: Silver
      widgets:
        - label: {id: current_weather_label_dt0, x: 70, y: 20, text_font: montserrat_20, text: '...'}
        - textarea: {id: current_weather_label, x: 40, y: 40, height: 170, width: 320, text_font: montserrat_20, text: '...'}
        - label: {id: current_weather_label_dt1, x: 460, y: 20, text_font: montserrat_20, text: '...'}
        - textarea: {id: current_weather_label_1, x: 440, y: 40, height: 170, width: 320, text_font: montserrat_20, text: '...'}
        - label: {id: current_weather_label_dt2, x: 70, y: 240, text_font: montserrat_20, text: '...'}
        - textarea: {id: current_weather_label_2, x: 40, y: 260, height: 170, width: 320, text_font: montserrat_20, text: '...'}
        - label: {id: current_weather_label_dt3, x: 460, y: 240, text_font: montserrat_20, text: '...'}
        - textarea: {id: current_weather_label_3, x: 440, y: 260, height: 170, width: 320, text_font: montserrat_20, text: '...'} 

  top_layer:
    widgets:
      - obj:
          align: bottom_mid
          width: 100%
          height: 40
          bg_color: 0x2F8CD8
          bg_opa: COVER
          border_width: 0
          pad_all: 0
          widgets:
            - buttonmatrix:
                align: CENTER
                width: 100%
                height: 100%
                styles: header_footer
                id: nav_bar
                rows:
                  - buttons:
                    - text: "\uE0F0" 
                      on_press: {then: [light.turn_on: lcdbacklight]}
                    - text: "\uE5C4" 
                      on_press: {then: [lvgl.page.previous: ]}
                    - text: "\uE88A" 
                      on_press: {then: [lvgl.page.show: main_page]}
                    - text: "\uE8AC" 
                      on_press: {then: [light.turn_off: lcdbacklight]}
                    - text: "\uE5C8" 
                      on_press: {then: [lvgl.page.next: ]} 

# ---------------------------------------------------------
# SENSORS & LOGIC 
# ---------------------------------------------------------
sensor:
  - platform: wifi_signal
    name: "WiFi Signal"
    update_interval: 60s 
    
  - platform: uptime
    name: "Uptime" 

  - platform: homeassistant
    id: inside_temperature
    entity_id: sensor.devtest2_bme280_temperature_devtest2
    on_value:
      - lvgl.indicator.update: {id: temperature_needle, value: !lambda 'return x;'} 
      - lvgl.label.update: {id: temperature_text, text: {format: "%.1f°F", args: ['x']}} 

  - platform: homeassistant
    id: inside_humidity
    entity_id: sensor.devtest2_bme280_humidity_devtest2
    on_value:
      - lvgl.indicator.update: {id: humidity_needle, value: !lambda 'return x;'}
      - lvgl.label.update: {id: humidity_text, text: {format: "%.1f%%", args: ['x']}} 

  - platform: homeassistant
    id: outside_temperature
    entity_id: sensor.tempcurrent
    on_value:
      - lvgl.indicator.update: {id: temperature_needle_2, value: !lambda 'return x;'}
      - lvgl.label.update: {id: temperature_text_2, text: {format: "%.1f°F", args: ['x']}} 

  - platform: homeassistant
    id: outside_humidity
    entity_id: sensor.humiditycurrent
    on_value:
      - lvgl.indicator.update: {id: humidity_needle_2, value: !lambda 'return x;'}
      - lvgl.label.update: {id: humidity_text_2, text: {format: "%.1f%%", args: ['x']}} 
          
  - platform: homeassistant
    id: barometer_pressure
    entity_id: sensor.pressurecurrent
    on_value:   
      - lvgl.indicator.update: {id: barometer_needle, value: !lambda 'return x;'}
      - lvgl.label.update: {id: barometer_text, text: {format: "%.1finHG", args: ['x']}} 

# ---------------------------------------------------------
# TEXT SENSORS, SCRIPTS & SYSTEM CONTROLS
# ---------------------------------------------------------
text_sensor:
  - platform: version
    id: esphome_version
    name: "ESPHome Version" 

  - platform: homeassistant
    id: extraweatherforecast0
    entity_id: input_text.text_nws_extra_forecast
    on_value: {then: [lvgl.textarea.update: {id: current_weather_label, text: !lambda 'return x.c_str();'}]}
  - platform: homeassistant
    id: extraweatherdatetime0
    entity_id: input_text.text_nws_extra_datetime_0
    on_value: {then: [lvgl.label.update: {id: current_weather_label_dt0, text: !lambda 'return x.c_str();'}]}

  - platform: homeassistant
    id: extraweatherforecast1
    entity_id: input_text.text_nws_extra_forecast_1
    on_value: {then: [lvgl.textarea.update: {id: current_weather_label_1, text: !lambda 'return x.c_str();'}]}
  - platform: homeassistant
    id: extraweatherdatetime1
    entity_id: input_text.text_nws_extra_datetime_1
    on_value: {then: [lvgl.label.update: {id: current_weather_label_dt1, text: !lambda 'return x.c_str();'}]}
    
  - platform: homeassistant
    id: extraweatherforecast2
    entity_id: input_text.text_nws_extra_forecast_2
    on_value: {then: [lvgl.textarea.update: {id: current_weather_label_2, text: !lambda 'return x.c_str();'}]}
  - platform: homeassistant
    id: extraweatherdatetime2
    entity_id: input_text.text_nws_extra_datetime_2
    on_value: {then: [lvgl.label.update: {id: current_weather_label_dt2, text: !lambda 'return x.c_str();'}]}
    
  - platform: homeassistant
    id: extraweatherforecast3
    entity_id: input_text.text_nws_extra_forecast_3
    on_value: {then: [lvgl.textarea.update: {id: current_weather_label_3, text: !lambda 'return x.c_str();'}]}
  - platform: homeassistant
    id: extraweatherdatetime3
    entity_id: input_text.text_nws_extra_datetime_3
    on_value: {then: [lvgl.label.update: {id: current_weather_label_dt3, text: !lambda 'return x.c_str();'}]}

script:
  - id: time_update
    then:
      - lvgl.indicator.update: {id: second_hand, value: !lambda "return id(homeassistant_time).now().second;"}
      - lvgl.indicator.update: {id: minute_hand, value: !lambda "return id(homeassistant_time).now().minute;"}
      - lvgl.indicator.update: {id: hour_hand, value: !lambda "auto now = id(homeassistant_time).now(); return std::fmod(now.hour, 12) * 60 + now.minute;"}
      - lvgl.label.update: 
          id: date_label 
          text: !lambda |-
            static const char * const mon_names[] = {"JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"};
            static char date_buf[16];
            auto now = id(homeassistant_time).now();
            snprintf(date_buf, sizeof(date_buf), "%s %2d", mon_names[now.month-1], now.day_of_month);
            return date_buf;
      - lvgl.label.update:
          id: day_label
          text: !lambda |-
            static const char * const day_names[] = {"SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"};
            return day_names[id(homeassistant_time).now().day_of_week - 1];

switch:
  - platform: template
    name: "Backlight Toggle"
    id: backlight_web_toggle
    optimistic: true
    turn_on_action:
      - light.turn_on: lcdbacklight
    turn_off_action:
      - light.turn_off: lcdbacklight 

button:
  - platform: template
    name: "Next Page"
    icon: "mdi:arrow-right-bold"
    on_press:
      - lvgl.page.next: 
  - platform: template
    name: "Previous Page"
    icon: "mdi:arrow-left-bold"
    on_press:
      - lvgl.page.previous: 
  - platform: restart
    name: "Restart Device"
